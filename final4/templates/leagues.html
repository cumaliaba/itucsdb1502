{%extends "layout.html"%}

{%block title%}Leagues{%endblock%}

{%block script%}
    <script>
        $(document).ready(function(){
            $('#delete_selectedBtn').click(function(){
                var ids=[];
                $('#table input:checked').each(function(){
                    ids.push(this.name);
                });
                console.log(ids);
                
                $.ajax({
                    url: '/leagues',
                    data: {'ids': ids,
                    },
                    type: 'DEL',
                    success: function(response) {
                        var data=JSON.parse(response);
                        if (data.status == 'OK') {
                            
                            console.log('DELETED');
                            console.log(data['idlist']);
                            console.log(data.idlist.length);
                            for(var i=0; i<data.idlist.length; i++) {
                                var domname = "tr[name="+data.idlist[i]+"]";
                                console.log(domname);
                                $(domname).hide()
                            }
                        }
                        ids=[];
                    },
                    error: function(error) {
                        console.log(error);
                        ids=[];
                    }
                });
            });

            $('.delete_itemBtn').click(function() {
                console.log("deleteItem");
                console.log(this.name);
                $.ajax({
                    url: '/leagues',
                    data: {'id': this.name,
                    },
                    type: 'DEL',
                    success: function(response) {
                        var data=JSON.parse(response);
                        if (data.status == 'OK') {
                            
                            console.log('DELETED');
                            console.log(data['idlist']);
                            console.log(data.idlist.length);
                            for(var i=0; i<data.idlist.length; i++) {
                                var domname = "tr[name="+data.idlist[i]+"]";
                                console.log(domname);
                                $(domname).hide()
                            }
                        }
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });

            });
            
            $('.update_itemBtn').click(function() {
                console.log("updateItem");
                console.log(this.name);
                console.log(this);
                var name=this.name;
                $.ajax({
                    url: '/leagues/g/'+this.name,
                    data: {'id': this.name,
                    },
                    type: 'GET',
                    success: function(response) {
                        var data=JSON.parse(response);
                        if (data.status == 'OK') {
                            // show update item form
                            $('#league_item_update').removeClass('hidden');
                            
                            // get selected item data from server response 
                            league=data['league'];
                            $('#league_item_update input[name=name]').val(league['name']);
                            $('#league_item_update select[name=country]').val(league['country_id']);
                            $('#league_item_update input[name=id]').val(league['id']);
                            var base_url = window.location.origin;
                            var newurl = base_url + "/leagues/g/" + league['id']; 
                            $('#update_form').attr('action', newurl);
                        }
                        
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            });

            $('#searchBox').change(function(){
                var key=$('#searchBox').val();

                var base_url = window.location.origin;
                var search_url = base_url + "/leagues/s/" + key
                window.location.replace(search_url); 
            });

        });
    </script>
{%endblock%}

{%block content%}
    {%if error%}<p>{{error}}</p>{%endif%}
        <div class="col-md-12">
            <div id="search">
                <input id="searchBox" type="text" name="search" placeholder="Enter search key">
                <button id="searchBtn">Search</button>
            </div>
            {%if leagues|length==0%}
            <p id="no_result"class="notice">No result found for selected criterias</p>
            {%else%}
            
            <div class="col-md-6">
                <table id="table" class="table table-hover">
                    <tr>
                        <th></th>
                        {%for var in leaguetable[1:]%}
                            {%if var=='country_id'%}
                            {%else%}
                            <th>{{var}}</th>
                            {%endif%}
                        {%endfor%}
                            <th></th>
                            <th></th>
                    </tr>
                    {%for l in leagues%}
                    <tr name="{{l._id}}">
                        <td><input type="checkbox" class="checkbox checkbox-warning" name="{{l._id}}" ></td>
                        <td>{{l.name}}</td>
                        <td>{{l.country}}</td>
                        <td><button name="{{l._id}}" class="delete_itemBtn">Delete</button></td>
                        <td><button name="{{l._id}}" class="update_itemBtn">Update</button></td>
                    </tr>
                    {%endfor%}
                </table>
                {%endif%}
                <div id="league_item_input" class="league_item_input">
                    <form action="{{url_for('league_page')}}" method="post">
                    <table id="add_item_table">
                        <tr id="add_item_table_tr">
                            {%for var in leaguetable[1:] %}
                            <td>
                                {%if var=='country_id'%}
                                {%elif var=='country'%}
                                <select id="country" name="{{var}}">
                                        {%for c in countries%}
                                        <option value="{{c._id}}" name="{{c.name}}">{{c.name}}</option>
                                        {%endfor%}
                                    </select>
                                {%else%}
                                <input type="text" name="{{var}}" placeholder="{{var}}">
                                {%endif%}
                            </td> 
                            {%endfor%}
                            <td><input type="submit" name="Add" id="add_itemBtn" value="Add"></td>
                        </tr>
                    </table>
                    </form>
                </div>

                <div id="league_item_update" class="hidden">
                    <form id="update_form" action="{{url_for('league_page')}}" method="POST">
                    <table id="update_item_table">
                        <tr id="update_item_table_tr">
                            {%for var in leaguetable[1:] %}
                            <td>
                                {% if var=='country_id'%}
                                {% elif var=='country'%}
                                <select id="country" name="{{var}}">
                                        {%for c in countries%}
                                        <option value="{{c._id}}" name="{{c.name}}">{{c.name}}</option>
                                        {%endfor%}
                                    </select>
                                {%else%}
                                <input type="text" name="{{var}}" placeholder="{{var}}">
                                {%endif%}
                            </td> 
                            {%endfor%}
                                <td><input type="text" name="id" class="hidden"></td>
                                <td><input type="submit" name="Update" id="update" value="Update"></td>
                        </tr>
                    </table>
                    </form>
                </div>
            </div>
        </div>

        {%if leagues|length>=1 %} 
            <button type="button" id="delete_selectedBtn">Delete Selections</button>
        {%endif%}
{%endblock%}
